@page
@model ChatModel
@{
    ViewData["Title"] = "Chat Realtime";
}
<h2>Chat Realtime</h2>

<div>
    <input type="text" id="messageInput" placeholder="Enter your message..." />
    <button id="sendButton">Send</button>
</div>

<div id="messagesList"></div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/microsoft-signalr/5.0.11/signalr.min.js"></script>
    <script>
        const senderId = 1; // Giả lập senderId (để test)
        const receiverId = 2; // Giả lập receiverId (để test)

        // Kết nối với SignalR hub
        const connection = new signalR.HubConnectionBuilder()
            .withUrl("/chatHub")
            .build();

        // Nhận tin nhắn từ SignalR
        connection.on("ReceiveMessage", function (user, message, sentTime) {
            const li = document.createElement("li");
            li.textContent = `[User ${user}] (${new Date(sentTime).toLocaleTimeString()}): ${message}`;
            document.getElementById("messagesList").appendChild(li);
        });

        connection.start().then(function () {
            console.log("Connected to SignalR hub");

            // Tham gia vào cuộc trò chuyện
            connection.invoke("JoinSpecificChat", { SenderId: senderId, ReceiverId: receiverId, Id: 1 });
        }).catch(function (err) {
            return console.error(err.toString());
        });

        // Gửi tin nhắn khi nhấn nút
        document.getElementById("sendButton").addEventListener("click", function () {
            const message = document.getElementById("messageInput").value;
            const messageRequest = {
                SenderId: 5,
                ReceiverId: 6,
                MessageText: message
            };

            // Gửi tin nhắn qua SignalR
            connection.invoke("SendMessage", messageRequest).catch(function (err) {
                return console.error(err.toString());
            });

            document.getElementById("messageInput").value = '';
        });
    </script>
}
